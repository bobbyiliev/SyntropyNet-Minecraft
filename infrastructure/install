#!/bin/bash

#/
#--------------------------------------------------------------------------
# Install All Dependencies for the Syntropy Network
# To run the setup script just execute the follwoing commands:
# export export API_KEY=YOUR_API_KEY_HERE
# git clone https://github.com/bobbyiliev/SyntropyNet-Minecraft /var/www/syntropynet ; cd /var/www/syntropynet ; time bash infrastructure/install
#--------------------------------------------------------------------------
#/

PHP="7.4"
MYSQL_SERVICE="MySQL"
MYSQL_PACKAGE="mysql-server"

function nginx_install(){
    echo  "| Installing Nginx ";

    apt update -y
    apt -y install nginx
    systemctl restart nginx
}

function mysql_install(){
    echo  "| Installing $MYSQL_SERVICE ";

    MYSQLPASS=$(openssl rand -base64 32)

    apt update

    echo '[client]' > ${HOME}/.my.cnf
    echo 'user=root' >> ${HOME}/.my.cnf
    echo 'password='${MYSQLPASS} >> ${HOME}/.my.cnf

    chmod 600 ${HOME}/.my.cnf

    export DEBIAN_FRONTEND=noninteractive
    echo "mysql-server-5.7 mysql-server/root_password password $MYSQLPASS" | sudo debconf-set-selections
    echo "mysql-server-5.7 mysql-server/root_password_again password $MYSQLPASS" | sudo debconf-set-selections
    echo "mysql-server mysql-server/root-pass password ${MYSQLPASS}"|sudo debconf-set-selections
    echo "mysql-server mysql-server/re-root-pass password ${MYSQLPASS}"|sudo debconf-set-selections
    echo "mysql-server-8.0 mysql-server/root-pass password ${MYSQLPASS}"|sudo debconf-set-selections
    echo "mysql-server-8.0 mysql-server/re-root-pass password ${MYSQLPASS}"|sudo debconf-set-selections


    apt install -y ${MYSQL_PACKAGE}
}

function php_install(){
    echo  "| Installing PHP $PHP and all necessary files";

    apt update
    apt install -y language-pack-en-base
    export LC_ALL=en_US.UTF-8
    export LANG=en_US.UTF-8
    apt install -y software-properties-common
    add-apt-repository -y ppa:ondrej/php
    apt -y update
    apt -y upgrade

    apt install -y unzip php-cli screen
    apt install -y php$PHP-cli php$PHP-common php$PHP-mysql php$PHP-gd php$PHP-mysql php$PHP-curl php$PHP-mbstring php$PHP-xml php$PHP-zip php$PHP-fpm curl git

    rm /usr/bin/php
    ln -s /usr/bin/php$PHP /usr/bin/php
}

function swap_setup(){
    CHECK_SWAP=$(swapon -s | wc -l)
    if [ $CHECK_SWAP -lt 1 ] ; then

        echo  "| Adding swap file "


        # Create a swap file
        sudo fallocate -l 1G /swapfile
        sudo chmod 600 /swapfile
        sudo mkswap /swapfile
        sudo swapon /swapfile

        # Making the swap file permanent
        sudo cp /etc/fstab /etc/fstab.bak
        echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
    fi
}

function composer_install(){
    echo  "| Installing Composer ";

    curl -sS https://getcomposer.org/installer | sudo php -- --install-dir=/usr/local/bin --filename=composer
}

function npm_install(){
    echo  "| Installing npm"

    curl -sL https://deb.nodesource.com/setup_16.x | sudo bash -
    sudo apt-get install -y nodejs
}

function laravel_install(){

    echo  "| Install Laravel "

    sudo chown -R www-data:www-data /var/www

    mysql -e "CREATE DATABASE wave";
    cd /var/www/syntropynet

    cp .env.example .env

    composer install

    php artisan key:generate

    php artisan migrate

    php artisan db:seed

}

function bungeecord_install(){
    echo  "| Start BungeeCord Proxy in Screen "

    screen -S BungeeCord -X stuff 'cd /var/www/syntropynet/infrastrucutre ; java -Xms512M -Xmx512M -jar BungeeCord.jar^M'
}

function docker_install(){
    apt update -y
    apt install docker.io
}

function start_syntropy_agent(){
    docker run --network="host" --restart=on-failure:10 --cap-add=NET_ADMIN   --cap-add=SYS_MODULE -v /var/run/docker.sock:/var/run/docker.sock:ro   --device /dev/net/tun:/dev/net/tun --name=syntropynet-agent   -e SYNTROPY_API_KEY=${API_KEY}   -e SYNTROPY_NETWORK_API='docker' -d syntropynet/agent:stable
}

function main(){

    if [[ -z ${API_KEY} ]] ; then
        echo "Specify the Syntrpy API Key with:"
        echo ""
        echo "export API_KEY=YOUR_API_KEY_HERE"
        exit 1
    fi

    echo "| Install All Dependencies for the Syntropy Network"

    # Call all functions
    nginx_install
    mysql_install
    php_install
    swap_setup
    composer_install
    npm_install
    laravel_install
    bungeecord_install
    docker_install
    start_syntropy_agent
    echo  "| Happy Gaming! "
}

main